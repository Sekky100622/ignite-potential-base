{% extends 'base.html' %}
{% block title %}{% if edit %}è¨˜äº‹ã‚’ç·¨é›†{% else %}æ–°è¦è¨˜äº‹{% endif %} | ã‚¤ã‚°ãƒ©ã‚¤ãƒˆãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ãƒ™ãƒ¼ã‚¹{% endblock %}

{% block extra_head %}
<style>
  .editor-toolbar {
    display: flex;
    gap: .4rem;
    flex-wrap: wrap;
    padding: .5rem;
    background: rgba(0,0,0,.2);
    border: 1.5px solid rgba(255,255,255,.12);
    border-bottom: none;
    border-radius: 8px 8px 0 0;
  }
  .editor-toolbar button {
    padding: .3rem .6rem;
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.1);
    border-radius: 4px;
    color: var(--white);
    cursor: pointer;
    font-size: .8rem;
    font-family: monospace;
    transition: background .2s;
  }
  .editor-toolbar button:hover { background: rgba(249,115,22,.3); }
  #content {
    border-radius: 0 0 8px 8px;
    font-family: 'Courier New', monospace;
    font-size: .9rem;
    min-height: 420px;
  }
  .preview-box {
    background: rgba(255,255,255,.04);
    border: 1.5px solid rgba(255,255,255,.12);
    border-radius: 8px;
    padding: 1.25rem;
    min-height: 200px;
    margin-top: .5rem;
    display: none;
  }
  .preview-box.active { display: block; }
  .preview-box h1,h2,h3 { color: var(--white); margin: 1rem 0 .5rem; }
  .preview-box h2 { border-bottom: 1px solid rgba(249,115,22,.3); padding-bottom: .3rem; }
  .preview-box p { color: var(--gray-200); line-height: 1.8; margin-bottom: .75rem; }
  .preview-box ul, .preview-box ol { color: var(--gray-200); padding-left: 1.5rem; margin-bottom: .75rem; }
  .tab-btn { padding:.4rem 1rem;border-radius:6px;font-size:.85rem;cursor:pointer;border:none;font-weight:500; }
  .tab-btn.active { background:var(--orange);color:var(--white); }
  .tab-btn:not(.active) { background:rgba(255,255,255,.08);color:var(--gray-200); }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="container">
    <h1>{% if edit %}âœï¸ è¨˜äº‹ã‚’ç·¨é›†{% else %}ğŸ“ æ–°è¦è¨˜äº‹ä½œæˆ{% endif %}</h1>
    <p>Markdownå½¢å¼ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å…¥åŠ›ã§ãã¾ã™</p>
  </div>
</div>

<section class="section-sm">
  <div class="container" style="max-width:900px;">
    <form method="POST">
      <div style="display:grid;grid-template-columns:1fr 280px;gap:1.5rem;">

        <!-- Main form -->
        <div>
          <div style="background:var(--navy-light);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:1.75rem;">
            <div class="form-group">
              <label class="form-label" for="title">ã‚¿ã‚¤ãƒˆãƒ« *</label>
              <input class="form-control" type="text" id="title" name="title"
                     placeholder="è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›"
                     value="{{ article.get('title', '') }}" required
                     oninput="autoSlug(this.value)">
            </div>

            <div class="form-group">
              <label class="form-label" for="slug">ã‚¹ãƒ©ãƒƒã‚°ï¼ˆURLï¼‰*</label>
              <input class="form-control" type="text" id="slug" name="slug"
                     placeholder="my-article-slug"
                     value="{{ article.get('slug', '') }}" required>
              <div class="text-gray text-sm" style="margin-top:.3rem;">URLã«ä½¿ç”¨ã€‚è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ã€‚</div>
            </div>

            <div class="form-group">
              <label class="form-label" for="excerpt">æ¦‚è¦ï¼ˆä¸€è¦§è¡¨ç¤ºç”¨ï¼‰</label>
              <textarea class="form-control" id="excerpt" name="excerpt"
                        style="min-height:80px;"
                        placeholder="è¨˜äº‹ã®æ¦‚è¦ã‚’2ã€œ3æ–‡ã§å…¥åŠ›">{{ article.get('excerpt', '') }}</textarea>
            </div>

            <!-- Editor tabs -->
            <div class="form-group">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">
                <label class="form-label" style="margin:0;">æœ¬æ–‡ï¼ˆMarkdownï¼‰*</label>
                <div style="display:flex;gap:.4rem;">
                  <button type="button" class="tab-btn active" id="editTab" onclick="showEdit()">ç·¨é›†</button>
                  <button type="button" class="tab-btn" id="previewTab" onclick="showPreview()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                </div>
              </div>

              <!-- Toolbar -->
              <div class="editor-toolbar">
                <button type="button" onclick="wrap('## ', '')">H2</button>
                <button type="button" onclick="wrap('### ', '')">H3</button>
                <button type="button" onclick="wrap('**', '**')"><b>B</b></button>
                <button type="button" onclick="wrap('*', '*')"><i>I</i></button>
                <button type="button" onclick="insertList()">â€¢ List</button>
                <button type="button" onclick="insertCode()">Code</button>
                <button type="button" onclick="wrap('> ', '')">Quote</button>
                <button type="button" onclick="insertLink()">Link</button>
              </div>
              <textarea class="form-control" id="content" name="content"
                        placeholder="# ã‚¿ã‚¤ãƒˆãƒ«&#10;&#10;ã“ã“ã«æœ¬æ–‡ã‚’Markdownå½¢å¼ã§å…¥åŠ›...">{{ article.get('content', '') }}</textarea>
              <div class="preview-box" id="previewBox"></div>
            </div>
          </div>
        </div>

        <!-- Sidebar settings -->
        <div>
          <!-- Publish -->
          <div style="background:var(--navy-light);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:1.25rem;margin-bottom:1rem;">
            <h4 style="font-size:.85rem;color:var(--gray-400);text-transform:uppercase;margin-bottom:1rem;">å…¬é–‹è¨­å®š</h4>

            <div class="form-group">
              <label class="form-check">
                <input type="checkbox" name="published" id="published"
                       {% if article.get('published') %}checked{% endif %}>
                <span>å…¬é–‹ã™ã‚‹</span>
              </label>
            </div>

            <div class="form-group">
              <label class="form-check">
                <input type="checkbox" name="is_free" id="is_free"
                       {% if article.get('is_free') %}checked{% endif %}>
                <span>ç„¡æ–™å…¬é–‹ï¼ˆèª°ã§ã‚‚èª­ã‚ã‚‹ï¼‰</span>
              </label>
            </div>

            <div style="display:flex;flex-direction:column;gap:.5rem;margin-top:1rem;">
              <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;">
                {% if edit %}æ›´æ–°ã™ã‚‹{% else %}ä½œæˆã™ã‚‹{% endif %}
              </button>
              <a href="{{ url_for('admin_articles') }}" class="btn btn-ghost" style="width:100%;justify-content:center;">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </a>
            </div>
          </div>

          <!-- Category -->
          <div style="background:var(--navy-light);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:1.25rem;margin-bottom:1rem;">
            <h4 style="font-size:.85rem;color:var(--gray-400);text-transform:uppercase;margin-bottom:1rem;">ã‚«ãƒ†ã‚´ãƒªãƒ¼</h4>
            <select class="form-control" name="category_id" id="category_id">
              <option value="">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠ</option>
              {% for cat in categories %}
              <option value="{{ cat.id }}"
                {% if article.get('category_id') == cat.id %}selected{% endif %}>
                {{ cat.name }}
              </option>
              {% endfor %}
            </select>
          </div>

          <!-- Thumbnail -->
          <div style="background:var(--navy-light);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:1.25rem;">
            <h4 style="font-size:.85rem;color:var(--gray-400);text-transform:uppercase;margin-bottom:1rem;">ã‚µãƒ ãƒã‚¤ãƒ«</h4>
            <div class="form-group">
              <input class="form-control" type="url" name="thumbnail_url" id="thumbnail_url"
                     placeholder="https://..."
                     value="{{ article.get('thumbnail_url', '') }}">
            </div>
            <div id="thumbPreview" style="display:none;margin-top:.5rem;">
              <img id="thumbImg" style="width:100%;height:120px;object-fit:cover;border-radius:6px;">
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Auto-generate slug from title
function autoSlug(title) {
  const slugField = document.getElementById('slug');
  if (!slugField.dataset.manual) {
    slugField.value = title
      .toLowerCase()
      .replace(/[^\w\s-]/g, '')
      .replace(/[\s_]+/g, '-')
      .replace(/^-+|-+$/g, '');
  }
}
document.getElementById('slug').addEventListener('input', function() {
  this.dataset.manual = 'true';
});

// Markdown toolbar
function wrap(before, after) {
  const ta = document.getElementById('content');
  const start = ta.selectionStart;
  const end = ta.selectionEnd;
  const selected = ta.value.substring(start, end);
  ta.value = ta.value.substring(0, start) + before + selected + after + ta.value.substring(end);
  ta.focus();
  ta.setSelectionRange(start + before.length, end + before.length);
}
function insertList() {
  const ta = document.getElementById('content');
  const pos = ta.selectionStart;
  const text = '\n- é …ç›®1\n- é …ç›®2\n- é …ç›®3\n';
  ta.value = ta.value.substring(0, pos) + text + ta.value.substring(pos);
}
function insertCode() {
  wrap('`', '`');
}
function insertLink() {
  const url = prompt('URLã‚’å…¥åŠ›:', 'https://');
  if (url) wrap('[ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ](', url + ')');
}

// Preview tabs
function showEdit() {
  document.getElementById('content').style.display = 'block';
  document.getElementById('previewBox').classList.remove('active');
  document.getElementById('editTab').classList.add('active');
  document.getElementById('previewTab').classList.remove('active');
}
function showPreview() {
  document.getElementById('content').style.display = 'none';
  document.getElementById('previewBox').classList.add('active');
  document.getElementById('editTab').classList.remove('active');
  document.getElementById('previewTab').classList.add('active');
  // Simple markdown preview
  const content = document.getElementById('content').value;
  const html = simpleMarkdown(content);
  document.getElementById('previewBox').innerHTML = html;
}
function simpleMarkdown(md) {
  return md
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code>$1</code>')
    .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/^(?!<[h|u|b|l|p|c])/gm, '<p>')
    .replace(/$(?![<])/gm, '</p>');
}

// Thumbnail preview
document.getElementById('thumbnail_url').addEventListener('input', function() {
  const url = this.value;
  const preview = document.getElementById('thumbPreview');
  const img = document.getElementById('thumbImg');
  if (url) {
    img.src = url;
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
});
// Init thumbnail preview
const thumbUrl = document.getElementById('thumbnail_url').value;
if (thumbUrl) {
  document.getElementById('thumbImg').src = thumbUrl;
  document.getElementById('thumbPreview').style.display = 'block';
}
</script>
{% endblock %}
